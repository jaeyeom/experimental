---
# THIS FILE IS AUTO-GENERATED by generate_packages.go - DO NOT EDIT MANUALLY
# To make changes, modify generate_packages.go, install_methods.go, packages_data.go, or templates.go
# and then run: make
- import_playbook: gather-facts.yml
- import_playbook: setup-user-bin-directory.yml
  when: ansible_facts['env']['TERMUX_VERSION'] is not defined and ansible_facts['os_family'] != "Darwin"
- import_playbook: curl.yml
  when: ansible_facts['env']['TERMUX_VERSION'] is not defined and ansible_facts['os_family'] != "Darwin"

- name: Ensure pkl is present
  hosts: all
  tasks:
    - name: Include guard for pkl playbook
      block:
        - name: Stop early if the pkl playbook is already included
          meta: end_play
          when: pkl_playbook_imported is defined
        - name: Ensure the pkl playbook is not included
          set_fact:
            pkl_playbook_imported: true
          when: pkl_playbook_imported is not defined

    - name: Ensure pkl is present on MacOS
      block:
        - name: Check if pkl is installed
          shell: command -v pkl
          changed_when: False
      rescue:
        - name: Install pkl on MacOS
          community.general.homebrew:
            name: pkl
            state: present
      when: ansible_facts['os_family'] == "Darwin"

    - name: Install pkl via shell on Debian/Ubuntu
      block:
        - name: Check if pkl is installed
          shell: command -v pkl
          register: pkl_command_check
          failed_when: false
          changed_when: False

        - name: Get installed pkl version
          command: pkl --version
          register: pkl_version_output
          failed_when: false
          changed_when: False
          when: pkl_command_check.rc == 0

        - name: Parse installed pkl version
          set_fact:
            pkl_installed_version: "{{ (pkl_version_output.stdout | regex_search('Pkl ([0-9.]+)', '\\1')) | default(['0.0.0'], true) | first }}"
          when: pkl_command_check.rc == 0

        - name: Set default version when pkl is not installed
          set_fact:
            pkl_installed_version: "0.0.0"
          when: pkl_command_check.rc != 0

        - name: Get latest available pkl version from GitHub
          uri:
            url: https://api.github.com/repos/apple/pkl/releases/latest
            return_content: yes
            status_code: [200, 403]
            headers: "{{ {'Authorization': 'token ' + lookup('env', 'GITHUB_TOKEN')} if lookup('env', 'GITHUB_TOKEN') else {} }}"
          register: pkl_latest_release
          until: >-
            pkl_latest_release.status == 200 or
            (pkl_latest_release.status == 403 and
             (pkl_latest_release.x_ratelimit_remaining | default('1') | string) != '0')
          retries: 3
          delay: 120

        - name: Fail if pkl version fetch failed
          ansible.builtin.fail:
            msg: >-
              Failed to fetch pkl version from GitHub.
              Status: {{ pkl_latest_release.status }}.
              {% if pkl_latest_release.status == 403 and (pkl_latest_release.x_ratelimit_remaining | default('1') | string) == '0' %}
              Rate limit exceeded after retries. Please try again later or set GITHUB_TOKEN environment variable.
              {% endif %}
          when: pkl_latest_release.status != 200

        - name: Parse latest pkl version from GitHub response
          set_fact:
            pkl_latest_version: "{{ pkl_latest_release.json.tag_name | regex_replace('^v', '') }}"

        - name: Install/update pkl if outdated
          shell: |
            arch=$(uname -m) && os=$(uname -s | tr '[:upper:]' '[:lower:]') && if [ "$arch" = "x86_64" ]; then arch="amd64"; elif [ "$arch" = "arm64" ]; then arch="aarch64"; fi && curl -L -o ~/.local/bin/pkl "https://github.com/apple/pkl/releases/download/{{ pkl_latest_release.json.tag_name }}/pkl-${os}-${arch}" && chmod +x ~/.local/bin/pkl
          when: pkl_installed_version != pkl_latest_version
      when: ansible_facts['env']['TERMUX_VERSION'] is not defined and ansible_facts['os_family'] != "Darwin"
