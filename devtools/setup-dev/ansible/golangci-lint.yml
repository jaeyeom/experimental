---
- import_playbook: curl.yml
- import_playbook: git.yml

- name: Ensure golangci-lint is installed
  hosts: all
  tasks:
    - name: Check if golangci-lint is installed
      command: golangci-lint --version
      register: golangci_lint_installed
      ignore_errors: yes

    - name: Determine the latest golangci-lint version from Github
      uri:
        url: https://api.github.com/repos/golangci/golangci-lint/releases/latest
        return_content: yes
      register: golangci_lint_release_info

    - name: Set the latest version of golangci-lint
      set_fact:
        golangci_lint_latest_version: "{{ golangci_lint_release_info.json.tag_name }}"

    - name: Install or update golangci-lint
      shell: |
        curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin {{ golangci_lint_latest_version }}
      when: (golangci_lint_installed.failed or
             golangci_lint_latest_version[1:] not in golangci_lint_installed.stdout) and
            ansible_env.TERMUX_VERSION is not defined

    # Termux somehow does not work with the install script. Though installing
    # golangci-lint with go install is not recommended, there are no other good
    # ways.
    - name: Install or update golangci-lint on Termux
      shell: |
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@{{ golangci_lint_latest_version }}
      when: (golangci_lint_installed.failed or
             golangci_lint_latest_version[1:] not in golangci_lint_installed.stdout) and
            ansible_env.TERMUX_VERSION is defined
