---
- import_playbook: curl.yml
- import_playbook: git.yml

- name: Ensure golangci-lint is installed
  hosts: all
  tasks:
    - name: Include guard for golangci-lint playbook
      block:
        - name: Stop early if the golangci-lint playbook is already included
          meta: end_play
          when: golangci_lint_playbook_imported is defined
        - name: Ensure the golangci-lint playbook is not included
          set_fact:
            golangci_lint_playbook_imported: true
          when: golangci_lint_playbook_imported is not defined

    - name: Check if golangci-lint is installed
      command: golangci-lint --version
      register: golangci_lint_installed
      ignore_errors: yes
      changed_when: False

    - name: Determine the latest golangci-lint version from Github
      ansible.builtin.uri:
        url: https://api.github.com/repos/golangci/golangci-lint/releases/latest
        return_content: yes
        status_code: [200, 403]
      register: golangci_lint_release_info
      until: >-
        golangci_lint_release_info.status == 200 or
        (golangci_lint_release_info.status == 403 and
         (golangci_lint_release_info.x_ratelimit_remaining | default('1') | string) != '0')
      retries: 3
      delay: 120

    - name: Fail if golangci-lint version fetch failed
      ansible.builtin.fail:
        msg: >-
          Failed to fetch golangci-lint version from GitHub.
          Status: {{ golangci_lint_release_info.status }}.
          {% if golangci_lint_release_info.status == 403 and (golangci_lint_release_info.x_ratelimit_remaining | default('1') | string) == '0' %}
          Rate limit exceeded after retries. Please try again later or use a GitHub token.
          {% endif %}
      when: golangci_lint_release_info.status != 200

    - name: Set the latest version of golangci-lint
      ansible.builtin.set_fact:
        golangci_lint_latest_version: "{{ golangci_lint_release_info.json.tag_name }}"

    - name: Install or update golangci-lint
      shell: |
        {{ playbook_dir }}/verified-run exec https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh -- -b $(go env GOPATH)/bin {{ golangci_lint_latest_version }}
      when: (golangci_lint_installed.failed or
             golangci_lint_latest_version[1:] not in golangci_lint_installed.stdout) and
            ansible_facts['env']['TERMUX_VERSION'] is not defined

    # The installation script works on Termux, but somehow the installed binary
    # does not work. Though installing golangci-lint with go install is not
    # recommended, there are no other good ways.
    - name: Install or update golangci-lint on Termux
      shell: |
        go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{ golangci_lint_latest_version }}
      when: (golangci_lint_installed.failed or
             golangci_lint_latest_version[1:] not in golangci_lint_installed.stdout) and
            ansible_facts['env']['TERMUX_VERSION'] is defined
