---
- import_playbook: jq.yml

- name: Setup Claude Code sandbox configuration
  hosts: all
  vars:
    claude_settings_dir: "{{ ansible_facts['env']['HOME'] }}/.claude"
    claude_settings_file: "{{ claude_settings_dir }}/settings.json"
    sandbox_config:
      includeCoAuthoredBy: false
      sandbox:
        enabled: true
        autoAllowBashIfSandboxed: true
        excludedCommands:
          - bazel
          - docker
          - git
          - make
        allowUnsandboxedCommands: true
        network:
          allowUnixSockets:
            - /var/run/docker.sock
          allowLocalBinding: true
      permissions:
        allow:
          - "Bash(bazel build:*)"  # Medium risk (may run genrule)
          - "Bash(bazel query:*)"
          - "Bash(bazel test:*)"   # Medium risk (may run genrule)
          - "Bash(git add:*)"
          - "Bash(git branch:*)"
          - "Bash(git commit:*)"
          - "Bash(git diff:*)"
          - "Bash(git log:*)"
          - "Bash(git status:*)"
          - "Bash(golangci-lint run:*)"
          - "Bash(ruff:*)"
        additionalFilesystemWritePaths:
          - "/var/tmp"
          - "/private/var/tmp"  # macOS symlink to /var/tmp
        deny:
          - "Bash(eval:*)"      # Shell eval
          - "Bash(find:*)"      # Glob tool is safer
          - "Bash(source:*)"    # Source scripts
          - "Bash(xargs:*)"     # Can execute arbitrary commands
          - "Read(.envrc)"
          - "Read(~/.aws/**)"
          - "Read(~/.azure/**)"
          - "Read(~/.bash_history)"
          - "Read(~/.config/gcloud/**)"
          - "Read(~/.config/gh/hosts.yml)"
          - "Read(~/.docker/config.json)"
          - "Read(~/.gnupg/**)"
          - "Read(~/.kube/config)"
          - "Read(~/.my.cnf)"
          - "Read(~/.netrc)"
          - "Read(~/.npmrc)"
          - "Read(~/.password-store/**)"
          - "Read(~/.pgpass)"
          - "Read(~/.pypirc)"
          - "Read(~/.ssh/**)"
          - "Read(~/.zsh_history)"
  tasks:
    - name: Include guard for claude sandbox playbook
      block:
        - name: Stop early if the claude sandbox playbook is already included
          meta: end_play
          when: claude_sandbox_playbook_imported is defined
        - name: Ensure the claude sandbox playbook is not included
          set_fact:
            claude_sandbox_playbook_imported: true
          when: claude_sandbox_playbook_imported is not defined

    - name: Create ~/.claude directory
      file:
        path: "{{ claude_settings_dir }}"
        state: directory
        mode: "0755"

    - name: Check if settings.json exists
      stat:
        path: "{{ claude_settings_file }}"
      register: settings_file_stat

    - name: Create empty settings.json if not exists
      copy:
        content: "{}"
        dest: "{{ claude_settings_file }}"
        mode: "0644"
      when: not settings_file_stat.stat.exists

    - name: Create temp file for sandbox config
      tempfile:
        state: file
        suffix: .json
      register: sandbox_config_temp

    - name: Write sandbox config to temp file
      copy:
        content: "{{ sandbox_config | to_nice_json }}"
        dest: "{{ sandbox_config_temp.path }}"
        mode: "0644"

    - name: Create temp file for merged config
      tempfile:
        state: file
        suffix: .json
      register: merged_config_temp

    - name: Merge sandbox config into settings.json using jq
      shell: |
        jq -s '.[0] * .[1]' "{{ claude_settings_file }}" "{{ sandbox_config_temp.path }}" > "{{ merged_config_temp.path }}" && \
        mv "{{ merged_config_temp.path }}" "{{ claude_settings_file }}"
      args:
        executable: /bin/bash
      register: merge_result
      changed_when: true

    - name: Clean up temp file
      file:
        path: "{{ sandbox_config_temp.path }}"
        state: absent

    - name: Display current sandbox settings
      shell: jq '.sandbox' "{{ claude_settings_file }}"
      register: sandbox_display
      changed_when: false

    - name: Show sandbox configuration
      debug:
        msg: "{{ sandbox_display.stdout }}"
