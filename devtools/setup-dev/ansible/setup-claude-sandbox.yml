---
- import_playbook: jq.yml
- import_playbook: setup-user-bin-directory.yml
- import_playbook: which.yml
- import_playbook: setup-claude-termux-rg.yml
  when: ansible_facts['env']['TERMUX_VERSION'] is defined

- name: Setup Claude Code sandbox configuration
  hosts: all
  vars:
    claude_settings_dir: "{{ ansible_facts['env']['HOME'] }}/.claude"
    claude_settings_file: "{{ claude_settings_dir }}/settings.json"
    claude_tmpdir_base: "{{ ansible_facts['env']['TMPDIR'] | default('/tmp', true) }}"
    claude_tmpdir: "{{ claude_tmpdir_base }}/claude"
    sandbox_config:
      includeCoAuthoredBy: false
      sandbox:
        enabled: true
        autoAllowBashIfSandboxed: true
        excludedCommands:
          - bazel
          - bazelisk  # bazel is often a symlink to bazelisk
          - docker
          - git
          - make
        allowUnsandboxedCommands: true
        network:
          allowedHosts:
            - api.github.com
          allowUnixSockets:
            - /var/run/docker.sock
          allowLocalBinding: true
      permissions:
        allow:
          - "Bash(bazel build:*)"  # Medium risk (may run genrule)
          - "Bash(bazel query:*)"
          - "Bash(bazel test:*)"   # Medium risk (may run genrule)
          - "Bash(gh issue close:*)"
          - "Bash(gh issue reopen:*)"
          - "Bash(gh issue view:*)"
          - "Bash(git add:*)"
          - "Bash(git branch:*)"
          - "Bash(git commit:*)"
          - "Bash(git diff:*)"
          - "Bash(git log:*)"
          - "Bash(git status:*)"
          - "Bash(golangci-lint run:*)"
          - "Bash(rg:*)"           # Safe: read-only search tool, no exec capability
          - "Bash(ruff:*)"
        deny:
          - "Bash(eval:*)"      # Shell eval
          - "Bash(source:*)"    # Source scripts
          - "Bash(xargs:*)"     # Can execute arbitrary commands
          - "Read(.envrc)"
          - "Read(~/.aws/**)"
          - "Read(~/.azure/**)"
          - "Read(~/.bash_history)"
          - "Read(~/.config/gcloud/**)"
          - "Read(~/.docker/config.json)"
          - "Read(~/.gnupg/**)"
          - "Read(~/.kube/config)"
          - "Read(~/.my.cnf)"
          - "Read(~/.netrc)"
          - "Read(~/.npmrc)"
          - "Read(~/.password-store/**)"
          - "Read(~/.pgpass)"
          - "Read(~/.pypirc)"
          - "Read(~/.ssh/**)"
          - "Read(~/.zsh_history)"
  tasks:
    - name: Include guard for claude sandbox playbook
      block:
        - name: Stop early if the claude sandbox playbook is already included
          meta: end_play
          when: claude_sandbox_playbook_imported is defined
        - name: Ensure the claude sandbox playbook is not included
          set_fact:
            claude_sandbox_playbook_imported: true
          when: claude_sandbox_playbook_imported is not defined

    - name: Create ~/.claude directory
      file:
        path: "{{ claude_settings_dir }}"
        state: directory
        mode: "0755"

    - name: Create Claude temp directory
      file:
        path: "{{ claude_tmpdir }}"
        state: directory
        mode: "0700"

    - name: Check if running in Termux
      ansible.builtin.stat:
        path: /data/data/com.termux
      register: termux_check

    - name: Create claude wrapper script in ~/.local/shims/bin
      copy:
        content: |
          {% if termux_check.stat.exists %}#!/data/data/com.termux/files/usr/bin/bash{% else %}#!/usr/bin/env bash{% endif %}
          # Wrapper script for Claude Code to enforce sandbox environment variables

          # Find the real claude (skipping this wrapper)
          # which -a returns absolute paths. We take the second one because this wrapper
          # is expected to be the first one in PATH.
          REAL_CLAUDE=$(which -a claude | sed -n '2p')

          if [[ -z "$REAL_CLAUDE" ]]; then
              echo "Error: No real claude found in PATH" >&2
              exit 1
          fi

          export CLAUDE_CODE_TMPDIR="${TMPDIR:-/tmp}/claude"
          export GOCACHE="${TMPDIR:-/tmp}/claude/go-build"
          export GOLANGCI_LINT_CACHE="${TMPDIR:-/tmp}/claude/golangci-lint"

          # Execute the real claude
          exec "$REAL_CLAUDE" "$@"
        dest: "{{ user_shims_bin_directory }}/claude"
        mode: "0755"

    - name: Check if settings.json exists
      stat:
        path: "{{ claude_settings_file }}"
      register: settings_file_stat

    - name: Create empty settings.json if not exists
      copy:
        content: "{}"
        dest: "{{ claude_settings_file }}"
        mode: "0644"
      when: not settings_file_stat.stat.exists

    - name: Create temp file for sandbox config
      tempfile:
        state: file
        suffix: .json
      register: sandbox_config_temp

    - name: Write sandbox config to temp file
      copy:
        content: "{{ sandbox_config | to_nice_json }}"
        dest: "{{ sandbox_config_temp.path }}"
        mode: "0644"

    - name: Create temp file for merged config
      tempfile:
        state: file
        suffix: .json
      register: merged_config_temp

    - name: Merge sandbox config into settings.json using jq
      shell: |
        jq -s '.[0] * .[1]' "{{ claude_settings_file }}" "{{ sandbox_config_temp.path }}" > "{{ merged_config_temp.path }}" && \
        mv "{{ merged_config_temp.path }}" "{{ claude_settings_file }}"
      args:
        executable: /bin/bash
      register: merge_result
      changed_when: true

    - name: Clean up temp file
      file:
        path: "{{ sandbox_config_temp.path }}"
        state: absent

    - name: Display current sandbox settings
      shell: jq '.sandbox' "{{ claude_settings_file }}"
      register: sandbox_display
      changed_when: false

    - name: Show sandbox configuration
      debug:
        msg: "{{ sandbox_display.stdout }}"
