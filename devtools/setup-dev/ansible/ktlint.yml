---
# THIS FILE IS AUTO-GENERATED by generate_packages.go - DO NOT EDIT MANUALLY
# To make changes, modify generate_packages.go, install_methods.go, packages_data.go, or templates.go
# and then run: make
- import_playbook: gather-facts.yml
- import_playbook: curl.yml
  when: ansible_facts['os_family'] != "Darwin"
- import_playbook: setup-user-bin-directory.yml
  when: ansible_facts['os_family'] != "Darwin"

- name: Ensure ktlint is present
  hosts: all
  tasks:
    - name: Include guard for ktlint playbook
      block:
        - name: Stop early if the ktlint playbook is already included
          meta: end_play
          when: ktlint_playbook_imported is defined
        - name: Ensure the ktlint playbook is not included
          set_fact:
            ktlint_playbook_imported: true
          when: ktlint_playbook_imported is not defined

    - name: Ensure ktlint is present on MacOS
      block:
        - name: Check if ktlint is installed
          shell: command -v ktlint
          changed_when: False
      rescue:
        - name: Install ktlint on MacOS
          community.general.homebrew:
            name: ktlint
            state: present
      when: ansible_facts['os_family'] == "Darwin"

    - name: Ensure ktlint is present on Termux
      block:
        - name: Check if ktlint is installed
          shell: command -v ktlint
          register: ktlint_command_check
          failed_when: false
          changed_when: False

        - name: Get installed ktlint version
          command: ktlint --version
          register: ktlint_version_output
          failed_when: false
          changed_when: False
          when: ktlint_command_check.rc == 0

        - name: Parse installed ktlint version
          set_fact:
            ktlint_installed_version: "{{ (ktlint_version_output.stdout | regex_search('([0-9.]+)', '\\1')) | default(['0.0.0'], true) | first }}"
          when: ktlint_command_check.rc == 0

        - name: Set default version when ktlint is not installed
          set_fact:
            ktlint_installed_version: "0.0.0"
          when: ktlint_command_check.rc != 0

        - name: Get latest available ktlint version from GitHub
          uri:
            url: https://api.github.com/repos/pinterest/ktlint/releases/latest
            return_content: yes
            status_code: [200, 403]
            headers: "{{ {'Authorization': 'token ' + lookup('env', 'GITHUB_TOKEN')} if lookup('env', 'GITHUB_TOKEN') else {} }}"
          register: ktlint_latest_release
          until: >-
            ktlint_latest_release.status == 200 or
            (ktlint_latest_release.status == 403 and
             (ktlint_latest_release.x_ratelimit_remaining | default('1') | string) != '0')
          retries: 3
          delay: 120

        - name: Fail if ktlint version fetch failed
          ansible.builtin.fail:
            msg: >-
              Failed to fetch ktlint version from GitHub.
              Status: {{ ktlint_latest_release.status }}.
              {% if ktlint_latest_release.status == 403 and (ktlint_latest_release.x_ratelimit_remaining | default('1') | string) == '0' %}
              Rate limit exceeded after retries. Please try again later or set GITHUB_TOKEN environment variable.
              {% endif %}
          when: ktlint_latest_release.status != 200

        - name: Parse latest ktlint version from GitHub response
          set_fact:
            ktlint_latest_version: "{{ ktlint_latest_release.json.tag_name | regex_replace('^v', '') }}"

        - name: Install/update ktlint if outdated
          shell: |
            curl -sSL https://github.com/pinterest/ktlint/releases/download/{{ ktlint_latest_release.json.tag_name }}/ktlint -o {{ user_bin_directory }}/ktlint && chmod a+x {{ user_bin_directory }}/ktlint
          when: ktlint_installed_version != ktlint_latest_version
      when: ansible_facts['env']['TERMUX_VERSION'] is defined

    - name: Install ktlint via shell on Debian/Ubuntu
      block:
        - name: Check if ktlint is installed
          shell: command -v ktlint
          register: ktlint_command_check
          failed_when: false
          changed_when: False

        - name: Get installed ktlint version
          command: ktlint --version
          register: ktlint_version_output
          failed_when: false
          changed_when: False
          when: ktlint_command_check.rc == 0

        - name: Parse installed ktlint version
          set_fact:
            ktlint_installed_version: "{{ (ktlint_version_output.stdout | regex_search('([0-9.]+)', '\\1')) | default(['0.0.0'], true) | first }}"
          when: ktlint_command_check.rc == 0

        - name: Set default version when ktlint is not installed
          set_fact:
            ktlint_installed_version: "0.0.0"
          when: ktlint_command_check.rc != 0

        - name: Get latest available ktlint version from GitHub
          uri:
            url: https://api.github.com/repos/pinterest/ktlint/releases/latest
            return_content: yes
            status_code: [200, 403]
            headers: "{{ {'Authorization': 'token ' + lookup('env', 'GITHUB_TOKEN')} if lookup('env', 'GITHUB_TOKEN') else {} }}"
          register: ktlint_latest_release
          until: >-
            ktlint_latest_release.status == 200 or
            (ktlint_latest_release.status == 403 and
             (ktlint_latest_release.x_ratelimit_remaining | default('1') | string) != '0')
          retries: 3
          delay: 120

        - name: Fail if ktlint version fetch failed
          ansible.builtin.fail:
            msg: >-
              Failed to fetch ktlint version from GitHub.
              Status: {{ ktlint_latest_release.status }}.
              {% if ktlint_latest_release.status == 403 and (ktlint_latest_release.x_ratelimit_remaining | default('1') | string) == '0' %}
              Rate limit exceeded after retries. Please try again later or set GITHUB_TOKEN environment variable.
              {% endif %}
          when: ktlint_latest_release.status != 200

        - name: Parse latest ktlint version from GitHub response
          set_fact:
            ktlint_latest_version: "{{ ktlint_latest_release.json.tag_name | regex_replace('^v', '') }}"

        - name: Install/update ktlint if outdated
          shell: |
            curl -sSL https://github.com/pinterest/ktlint/releases/download/{{ ktlint_latest_release.json.tag_name }}/ktlint -o {{ user_bin_directory }}/ktlint && chmod a+x {{ user_bin_directory }}/ktlint
          when: ktlint_installed_version != ktlint_latest_version
      when: ansible_facts['env']['TERMUX_VERSION'] is not defined and ansible_facts['os_family'] != "Darwin"
