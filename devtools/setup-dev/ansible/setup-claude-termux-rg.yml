---
# This playbook configures Claude Code to work properly on Termux by:
# 1. Setting TMPDIR environment variable (Termux cannot access /tmp)
# 2. Creating a ripgrep symlink (Claude Code doesn't ship arm64-android binary)
- import_playbook: claude.yml
- import_playbook: rg.yml
  when: ansible_facts['env']['TERMUX_VERSION'] is defined
- import_playbook: setup-shell-profile.yml

- name: Configure Claude Code for Termux
  hosts: all
  tasks:
    - name: Include guard for setup-claude-termux-rg playbook
      block:
        - name: Stop early if the setup-claude-termux-rg playbook is already included
          meta: end_play
          when: setup_claude_termux_rg_playbook_imported is defined
        - name: Ensure the setup-claude-termux-rg playbook is not included
          set_fact:
            setup_claude_termux_rg_playbook_imported: true
          when: setup_claude_termux_rg_playbook_imported is not defined

    - name: Configure TMPDIR for Claude Code on Termux
      block:
        - name: Check if TMPDIR export exists in shell profile
          lineinfile:
            path: "{{ user_profile_path }}"
            line: 'export TMPDIR=$PREFIX/tmp'
            state: present
          check_mode: yes
          register: tmpdir_check

        - name: Add TMPDIR export to shell profile
          lineinfile:
            path: "{{ user_profile_path }}"
            line: 'export TMPDIR=$PREFIX/tmp'
            create: yes
          when: tmpdir_check is changed

        - name: Ensure PREFIX/tmp directory exists
          file:
            path: "{{ ansible_facts['env']['PREFIX'] }}/tmp"
            state: directory
            mode: '0700'
      when: ansible_facts['env']['TERMUX_VERSION'] is defined

    - name: Configure ripgrep symlink for Claude Code on Termux
      block:
        - name: Get Claude Code ripgrep vendor directory
          shell: dirname $(npm root -g)/@anthropic-ai/claude-code/vendor/ripgrep/arm64-android
          register: rg_vendor_dir
          changed_when: false

        - name: Ensure arm64-android directory exists
          file:
            path: "{{ rg_vendor_dir.stdout }}/arm64-android"
            state: directory
            mode: '0755'

        - name: Create ripgrep symlink for Claude Code
          file:
            src: "{{ ansible_facts['env']['PREFIX'] }}/bin/rg"
            dest: "{{ rg_vendor_dir.stdout }}/arm64-android/rg"
            state: link
      when: ansible_facts['env']['TERMUX_VERSION'] is defined
