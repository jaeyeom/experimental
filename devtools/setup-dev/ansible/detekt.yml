---
# THIS FILE IS AUTO-GENERATED by generate_packages.go - DO NOT EDIT MANUALLY
# To make changes, modify generate_packages.go, install_methods.go, packages_data.go, or templates.go
# and then run: make
- import_playbook: gather-facts.yml
- import_playbook: curl.yml
  when: ansible_facts['env']['TERMUX_VERSION'] is not defined and ansible_facts['os_family'] != "Darwin"
- import_playbook: unzip.yml
  when: ansible_facts['env']['TERMUX_VERSION'] is not defined and ansible_facts['os_family'] != "Darwin"
- import_playbook: setup-user-bin-directory.yml
  when: ansible_facts['env']['TERMUX_VERSION'] is not defined and ansible_facts['os_family'] != "Darwin"

- name: Ensure detekt is present
  hosts: all
  tasks:
    - name: Include guard for detekt playbook
      block:
        - name: Stop early if the detekt playbook is already included
          meta: end_play
          when: detekt_playbook_imported is defined
        - name: Ensure the detekt playbook is not included
          set_fact:
            detekt_playbook_imported: true
          when: detekt_playbook_imported is not defined

    - name: Ensure detekt is present on MacOS
      block:
        - name: Check if detekt is installed
          shell: command -v detekt
          changed_when: False
      rescue:
        - name: Install detekt on MacOS
          community.general.homebrew:
            name: detekt
            state: present
      when: ansible_facts['os_family'] == "Darwin"

    - name: Install detekt via shell on Debian/Ubuntu
      block:
        - name: Check if detekt is installed
          shell: command -v detekt
          register: detekt_command_check
          failed_when: false
          changed_when: False

        - name: Get installed detekt version
          command: detekt --version
          register: detekt_version_output
          failed_when: false
          changed_when: False
          when: detekt_command_check.rc == 0

        - name: Parse installed detekt version
          set_fact:
            detekt_installed_version: "{{ (detekt_version_output.stdout | regex_search('([0-9.]+)', '\\1')) | default(['0.0.0'], true) | first }}"
          when: detekt_command_check.rc == 0

        - name: Set default version when detekt is not installed
          set_fact:
            detekt_installed_version: "0.0.0"
          when: detekt_command_check.rc != 0

        - name: Get latest available detekt version from GitHub
          uri:
            url: https://api.github.com/repos/detekt/detekt/releases/latest
            return_content: yes
            status_code: [200, 403]
            headers: "{{ {'Authorization': 'token ' + lookup('env', 'GITHUB_TOKEN')} if lookup('env', 'GITHUB_TOKEN') else {} }}"
          register: detekt_latest_release
          until: >-
            detekt_latest_release.status == 200 or
            (detekt_latest_release.status == 403 and
             (detekt_latest_release.x_ratelimit_remaining | default('1') | string) != '0')
          retries: 3
          delay: 120

        - name: Fail if detekt version fetch failed
          ansible.builtin.fail:
            msg: >-
              Failed to fetch detekt version from GitHub.
              Status: {{ detekt_latest_release.status }}.
              {% if detekt_latest_release.status == 403 and (detekt_latest_release.x_ratelimit_remaining | default('1') | string) == '0' %}
              Rate limit exceeded after retries. Please try again later or set GITHUB_TOKEN environment variable.
              {% endif %}
          when: detekt_latest_release.status != 200

        - name: Parse latest detekt version from GitHub response
          set_fact:
            detekt_latest_version: "{{ detekt_latest_release.json.tag_name | regex_replace('^v', '') }}"

        - name: Install/update detekt if outdated
          shell: |
            version="{{ detekt_latest_release.json.tag_name | regex_replace('^v', '') }}"
            curl -sSLO "https://github.com/detekt/detekt/releases/download/v${version}/detekt-cli-${version}.zip"
            unzip -o "detekt-cli-${version}.zip"
            rm "detekt-cli-${version}.zip"
            rm -rf {{ user_bin_directory }}/../lib/detekt
            mkdir -p {{ user_bin_directory }}/../lib
            mv "detekt-cli-${version}" {{ user_bin_directory }}/../lib/detekt
            ln -sf {{ user_bin_directory }}/../lib/detekt/bin/detekt-cli {{ user_bin_directory }}/detekt
          when: detekt_installed_version != detekt_latest_version
      when: ansible_facts['env']['TERMUX_VERSION'] is not defined and ansible_facts['os_family'] != "Darwin"
