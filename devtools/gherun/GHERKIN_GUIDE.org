#+TITLE: Writing Gherkin Files for gherun
#+AUTHOR: Jae Yeom
#+OPTIONS: toc:2

* Introduction

This guide explains how to write Gherkin feature files that work effectively
with ~gherun~ and AI-powered browsers like Perplexity Comet. While standard
Gherkin syntax applies, there are specific patterns that help AI browsers
execute tests more reliably.

* Gherkin Basics

** File Structure

A ~.feature~ file has this basic structure:

#+begin_src gherkin
  Feature: Feature Name
    As a [role]
    I want [goal]
    So that [benefit]

    Background:
      Given some common precondition

    Scenario: Scenario Name
      Given some context
      When some action
      Then expected outcome
#+end_src

** Feature Naming

The feature name is extracted and displayed in the GitHub issue. Choose
descriptive names:

#+begin_src gherkin
  # Good
  Feature: User Authentication

  # Avoid
  Feature: Auth
  Feature: Test Login Stuff
#+end_src

** File Naming Convention

~gherun~ extracts the feature ID from the filename:

| Filename                      | Feature ID          |
|-------------------------------+---------------------|
| ~login.feature~               | login               |
| ~user-authentication.feature~ | user-authentication |
| ~shopping_cart.feature~       | shopping_cart       |

Use descriptive, kebab-case or snake_case filenames.

* Template Variables

~gherun~ supports template variables to make feature files reusable across
different environments. Use the ~{{VAR_NAME}}~ syntax to reference variables.

** Syntax

Variables use double curly braces with alphanumeric names and underscores:

#+begin_example
{{BASE_URL}}
{{TEST_USER}}
{{API_KEY}}
#+end_example

** Providing Variables

*** Via Command Line

Use the ~--var~ flag to specify variables:

#+begin_src sh
  gherun --var BASE_URL=https://staging.example.com \
         --var TEST_USER=testuser@example.com \
         features/*.feature
#+end_src

*** Via Environment File

Create a ~.gherun.env~ file and use ~--env-file~:

#+begin_src sh
  # .gherun.env
  BASE_URL=https://staging.example.com
  TEST_USER=testuser@example.com
  PASSWORD=SecurePass123
#+end_src

#+begin_src sh
  gherun --env-file .gherun.env features/*.feature
#+end_src

*** Combining Both

Flag variables override env file values:

#+begin_src sh
  # Uses BASE_URL from flag, other vars from file
  gherun --env-file .gherun.env \
         --var BASE_URL=https://production.example.com \
         features/*.feature
#+end_src

** Example Feature File

#+begin_src gherkin
  Feature: User Authentication
    As a user
    I want to log in
    So that I can access my account

    Scenario: Successful login
      Given I navigate to "{{BASE_URL}}/login"
      When I enter "{{TEST_USER}}" in the "Email" field
      And I enter "{{PASSWORD}}" in the "Password" field
      And I click the "Log In" button
      Then I should be redirected to the dashboard
#+end_src

** Common Variables

| Variable       | Description                           | Example                          |
|----------------+---------------------------------------+----------------------------------|
| ~BASE_URL~     | Application base URL                  | ~https://staging.example.com~    |
| ~TEST_USER~    | Test user email                       | ~testuser@example.com~           |
| ~PASSWORD~     | Test user password                    | ~SecurePass123~                  |
| ~API_URL~      | API endpoint base URL                 | ~https://api.example.com~        |
| ~ADMIN_USER~   | Admin user for privileged tests       | ~admin@example.com~              |

** Error Handling

If a variable is referenced but not defined, ~gherun~ will fail with an error:

#+begin_example
Error: substituting variables in login.feature: undefined variables: BASE_URL, PASSWORD
#+end_example

This ensures you don't accidentally run tests with missing configuration.

** Best Practices

1. *Use meaningful names* - ~BASE_URL~ is clearer than ~URL~
2. *Document required variables* - Add a comment at the top of feature files
3. *Use env files for secrets* - Keep passwords out of command history
4. *Don't commit env files* - Add ~.gherun.env~ to ~.gitignore~

#+begin_src gherkin
  # Required variables:
  #   BASE_URL - The application URL (e.g., https://staging.example.com)
  #   TEST_USER - Email for test account
  #   PASSWORD - Password for test account

  Feature: User Authentication
    ...
#+end_src

* Writing AI-Friendly Scenarios

** Be Explicit About URLs

Always specify the full URL or clear navigation path:

#+begin_src gherkin
  # Good
  Scenario: Login to application
    Given I navigate to "https://example.com/login"
    When I enter "user@example.com" in the email field
    And I enter "password123" in the password field
    And I click the "Sign In" button
    Then I should see the dashboard

  # Avoid - ambiguous starting point
  Scenario: Login to application
    When I enter my credentials
    Then I should be logged in
#+end_src

** Use Visible Text for Element Identification

AI browsers work best with visible text rather than technical selectors:

#+begin_src gherkin
  # Good - uses visible text
  When I click the "Add to Cart" button
  When I click the link containing "View Details"
  When I select "California" from the "State" dropdown

  # Avoid - technical selectors
  When I click the element with id "btn-cart-add"
  When I click the first button in the product card
#+end_src

** Describe Expected Visual Outcomes

Be specific about what should be visible:

#+begin_src gherkin
  # Good
  Then I should see "Order confirmed" message
  Then the cart icon should show "3" items
  Then I should see a green success notification

  # Avoid
  Then it should work
  Then the page should update
#+end_src

** Include Wait Conditions

Specify when to wait for dynamic content:

#+begin_src gherkin
  # Good
  When I click "Submit"
  And I wait for the loading spinner to disappear
  Then I should see "Success"

  # Good - implicit wait
  When I click "Submit"
  Then I should see "Success" within 10 seconds
#+end_src

* Scenario Patterns

** Login Scenario

#+begin_src gherkin
  Feature: User Login
    As a registered user
    I want to log in to my account
    So that I can access my personalized content

    Scenario: Successful login with valid credentials
      Given I navigate to "https://example.com/login"
      When I enter "testuser@example.com" in the "Email" field
      And I enter "SecurePass123" in the "Password" field
      And I click the "Sign In" button
      Then I should be redirected to the dashboard
      And I should see "Welcome, Test User" in the header

    Scenario: Login fails with invalid password
      Given I navigate to "https://example.com/login"
      When I enter "testuser@example.com" in the "Email" field
      And I enter "wrongpassword" in the "Password" field
      And I click the "Sign In" button
      Then I should see "Invalid email or password" error message
      And I should remain on the login page
#+end_src

** Form Submission Scenario

#+begin_src gherkin
  Feature: Contact Form
    As a visitor
    I want to submit a contact form
    So that I can get in touch with support

    Scenario: Submit contact form successfully
      Given I navigate to "https://example.com/contact"
      When I enter "John Doe" in the "Name" field
      And I enter "john@example.com" in the "Email" field
      And I select "Sales Inquiry" from the "Subject" dropdown
      And I enter the following in the "Message" field:
        """
        I'm interested in learning more about your enterprise plan.
        Please contact me at your earliest convenience.
        """
      And I check the "I agree to the privacy policy" checkbox
      And I click the "Send Message" button
      Then I should see "Thank you for your message"
      And I should receive a confirmation email
#+end_src

** E-commerce Checkout Scenario

#+begin_src gherkin
  Feature: Shopping Cart Checkout
    As a customer
    I want to complete my purchase
    So that I can receive my ordered items

    Background:
      Given I am logged in as "customer@example.com"
      And I have items in my shopping cart

    Scenario: Complete checkout with credit card
      Given I navigate to "https://example.com/cart"
      When I click the "Proceed to Checkout" button
      Then I should see the checkout page

      When I enter "123 Main St" in the "Street Address" field
      And I enter "San Francisco" in the "City" field
      And I select "California" from the "State" dropdown
      And I enter "94102" in the "ZIP Code" field
      And I click "Continue to Payment"

      When I enter "4111111111111111" in the "Card Number" field
      And I enter "12/25" in the "Expiration" field
      And I enter "123" in the "CVV" field
      And I click "Place Order"

      Then I should see "Order Confirmed"
      And I should see an order number
      And I should receive an order confirmation email
#+end_src

** Search and Filter Scenario

#+begin_src gherkin
  Feature: Product Search
    As a shopper
    I want to search and filter products
    So that I can find what I'm looking for

    Scenario: Search for products and apply filters
      Given I navigate to "https://example.com/products"
      When I enter "wireless headphones" in the search box
      And I press Enter or click the search icon
      Then I should see search results for "wireless headphones"

      When I check the "Sony" checkbox under "Brand"
      And I select "$50 - $100" under "Price Range"
      And I select "4 stars & up" under "Rating"
      Then the results should be filtered accordingly
      And I should see only Sony headphones between $50 and $100

      When I click "Sort by" dropdown
      And I select "Price: Low to High"
      Then products should be sorted by price ascending
#+end_src

* Best Practices

** Keep Scenarios Focused

Each scenario should test one specific behavior:

#+begin_src gherkin
  # Good - focused scenarios
  Scenario: Add single item to cart
    ...

  Scenario: Update item quantity in cart
    ...

  Scenario: Remove item from cart
    ...

  # Avoid - too many things in one scenario
  Scenario: Test all cart functionality
    ...
#+end_src

** Use Background for Common Setup

#+begin_src gherkin
  Feature: User Profile Management

    Background:
      Given I am logged in as "user@example.com"
      And I navigate to "https://example.com/profile"

    Scenario: Update display name
      When I click "Edit Profile"
      And I change the "Display Name" to "New Name"
      And I click "Save"
      Then I should see "Profile updated"

    Scenario: Change password
      When I click "Security Settings"
      And I enter my current password
      And I enter a new password
      And I click "Update Password"
      Then I should see "Password changed"
#+end_src

** Provide Context for Failure Analysis

Include enough detail for meaningful failure reports:

#+begin_src gherkin
  Scenario: Verify order total calculation
    Given I have the following items in my cart:
      | Product          | Price  | Quantity |
      | Wireless Mouse   | $29.99 | 2        |
      | USB-C Cable      | $12.99 | 1        |
    When I view the cart summary
    Then the subtotal should be "$72.97"
    And the tax (8.5%) should be "$6.20"
    And the total should be "$79.17"
#+end_src

** Handle Dynamic Content

Account for content that may vary:

#+begin_src gherkin
  # Good - flexible matching
  Then I should see a timestamp in the format "MMM DD, YYYY"
  Then the order number should match pattern "ORD-[0-9]+"

  # Good - partial matching
  Then I should see text containing "items in your cart"
  Then the page title should contain "Dashboard"
#+end_src

* Writing Stateless Tests

Since Comet browser sessions may share state (cookies, sessions) between tests,
write tests that declare and verify their own preconditions. The AI browser
cannot clear cookies or storage programmaticallyâ€”state changes happen via UI.

** Why Stateless Tests Matter

- Tests running in parallel or sequentially may share browser state
- Comet's ~--incognito~ flag doesn't support automation
- No command-line option exists to manage profiles
- Each test should handle its own preconditions

** The Smart Approach: Check and Adapt

Rather than blindly logging out before every test, let each test:
1. Check the current state
2. Adapt only if needed (logout only if the test requires logged-out state)
3. Leave state as-is after completing (next test handles its own preconditions)

This avoids unnecessary login/logout cycles that slow down tests and add failure points.

** Declare Preconditions Explicitly

Start scenarios by stating what state they need:

#+begin_src gherkin
  # Test that needs logged-out state
  Scenario: New user registration
    Given I am on "https://example.com"
    And I am not logged in
    When I click "Sign Up"
    ...

  # Test that needs specific user logged in
  Scenario: View order history
    Given I am logged in as "customer@example.com"
    When I navigate to "https://example.com/orders"
    Then I should see my order history
#+end_src

** Use Background for Common Preconditions

For features where all scenarios share the same precondition:

#+begin_src gherkin
  Feature: Guest Checkout

    Background:
      Given I am on "https://example.com"
      And I am not logged in

    Scenario: Add item to cart as guest
      When I click "Add to Cart" on "Widget"
      Then the cart should show 1 item

    Scenario: Proceed to guest checkout
      Given I have items in my cart
      When I click "Checkout"
      Then I should see "Continue as Guest" option
#+end_src

** When to Log Out

Only log out when the test specifically requires a logged-out starting state:

#+begin_src gherkin
  # Good - logs out because registration requires it
  Scenario: New user registration
    Given I am on "https://example.com"
    And if I am logged in, I log out
    When I click "Sign Up"
    And I fill in the registration form
    Then I should see "Welcome, new user!"

  # Good - reuses existing session if possible
  Scenario: View dashboard
    Given I am logged in as "user@example.com"
    When I navigate to the dashboard
    Then I should see my stats
    # No logout needed - next test handles its own state
#+end_src

** Example Patterns

*** Pattern 1: Conditional State Setup

#+begin_src gherkin
  Scenario: Purchase item as logged-in user
    # Check and adapt
    Given I am on "https://example.com"
    And I am logged in as "buyer@example.com"

    # Test flow
    When I add "Widget" to my cart
    And I complete checkout
    Then I should see "Order Confirmed"
    # Leave state as-is for next test
#+end_src

*** Pattern 2: Explicit Logged-Out Requirement

#+begin_src gherkin
  Feature: Authentication

    Scenario: Login with valid credentials
      Given I am on "https://example.com/login"
      And I am not logged in
      When I enter "user@example.com" and "password123"
      And I click "Sign In"
      Then I should see "Welcome back"

    Scenario: Login shows error for invalid password
      Given I am on "https://example.com/login"
      And I am not logged in
      When I enter "user@example.com" and "wrongpassword"
      And I click "Sign In"
      Then I should see "Invalid credentials"
#+end_src

*** Pattern 3: Mixed State Requirements

#+begin_src gherkin
  Feature: Shopping Cart

    Scenario: Guest adds item to cart
      Given I am on "https://example.com/products"
      And I am not logged in
      When I click "Add to Cart" on "Widget"
      Then the cart should show 1 item

    Scenario: Member sees personalized recommendations
      Given I am logged in as "member@example.com"
      When I navigate to "https://example.com/products"
      Then I should see "Recommended for you"
#+end_src

* What to Avoid

** Avoid Technical Implementation Details

#+begin_src gherkin
  # Avoid
  When I trigger the onClick handler for the submit button
  When I wait for the AJAX request to complete
  When the React component re-renders

  # Better
  When I click the "Submit" button
  When the form submission completes
  When the page updates
#+end_src

** Avoid Ambiguous References

#+begin_src gherkin
  # Avoid
  When I click the button
  When I fill in the field
  When I select the option

  # Better
  When I click the "Add to Cart" button
  When I fill in the "Email" field with "test@example.com"
  When I select "Express Shipping" from the delivery options
#+end_src

** Avoid Time-Sensitive Assertions

#+begin_src gherkin
  # Avoid - fragile
  Then the banner should display for exactly 3 seconds

  # Better - flexible
  Then the banner should appear
  And after a moment, the banner should disappear
#+end_src

* Debugging Failed Tests

When Comet reports a test failure, it will leave a comment on the GitHub issue.
Common failure patterns:

| Symptom                    | Possible Cause                    | Solution                          |
|----------------------------+-----------------------------------+-----------------------------------|
| Element not found          | Element has different text        | Use more flexible text matching   |
| Timeout waiting            | Page loads slowly                 | Add explicit wait conditions      |
| Wrong page                 | Navigation failed                 | Verify URL is correct             |
| Unexpected content         | Dynamic content changed           | Use pattern matching              |

* Feature File Checklist

Before running your feature files with ~gherun~, verify:

- [ ] Feature has a descriptive name
- [ ] Filename is descriptive and uses kebab-case or snake_case
- [ ] Each scenario has a clear, single purpose
- [ ] URLs are explicit and complete
- [ ] Element references use visible text
- [ ] Expected outcomes are specific and verifiable
- [ ] Wait conditions are included for dynamic content
- [ ] No technical implementation details are exposed

* References

- [[https://cucumber.io/docs/gherkin/reference/][Official Gherkin Reference]]
- [[https://cucumber.io/docs/bdd/][Behavior-Driven Development]]
- [[https://www.perplexity.ai/][Perplexity AI]]
